<script type="text/javascript">
	RED.comms.subscribe('ncd-dependencies', (t,d) => {
		RED.notify(d);
	})
    RED.nodes.registerType('ncd-humichip',{
        category: 'NCD',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""},
			connection: {value: "", type: "ncd-comm"},
			interval: {value: 0, validate: RED.validators.number()},
			onchangeT: {value: 0, validate: RED.validators.number()},
			onchangeH: {value: 0, validate: RED.validators.number()},
			scale: {value: "f"},
			outputs: {value: 1},
			output_all: {value: 0},
        },
        inputs:1,
        outputs:1,
		icon: "serial.png",
        label: function() {
            return this.name || "HumiChip";
        },
		outputLabels: function(i){
			if(!this.output_all || i == 2) return 'Device Status';
			return i == 0 ? 'Humidity' : 'Temperature';
		},

		oneditsave: function(){
			this.outputs = $('#node-input-output_all').is(':checked') ? 3 : 1;
		}
    });
</script>

<script type="text/x-red" data-template-name="ncd-humichip">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
	<div class="form-row">
        <label for="node-input-connection"><i class="icon-tag"></i> I2C Connection</label>
        <select id="node-input-connection"></select>
    </div>
	<div class="form-row">
        <label for="node-input-interval"><i class="icon-repeat"></i> Interval</label>
        <input type="text" id="node-input-interval" placeholder="Interval">
    </div>
	<div class="form-row">
        <label for="node-input-onchangeT"><i class="icon-tag"></i> Temperature change threshold:</label>
        <input type="text" id="node-input-onchangeT" value="0" placeholder="<>">
    </div>
	<div class="form-row">
        <label for="node-input-onchangeH"><i class="icon-tag"></i> Humidity change threshold:</label>
        <input type="text" id="node-input-onchangeH" value="0" placeholder="<>">
    </div>
	<div class="form-row">
		<label for="node-input-output_all"><i class="icon-tag"></i> Output all channels</label>
		<input type="checkbox" id="node-input-output_all" value="1">
	</div>
	<div class="form-row">
		<label for="node-input-scale"><i class="icon-tag"></i> Temperature Scale</label>
		<select id="node-input-scale">
			<option value="f">Fahrenheit</option>
			<option value="c">Celsius</option>
			<option value="k">Kelvin</option>
		</select>
	</div>
</script>

<script type="text/x-red" data-help-name="ncd-mcp23008">
    <h3>I2C Connection</h3>
	<p>Configure the connection you want to use to communicate to your I2C device. Native I2C and USB to I2C converters are supported.</p>
	<h3>Device Address</h3>
	<p>The MCP23008 exposes hardware pins to make it easily addressable, on the NCD version these pins are controlled with jumpers and have the following values:</p>
	<ul>
		<li><b>None</b> 32</li>
		<li><b>A0</b> 33</li>
		<li><b>A1</b> 34</li>
		<li><b>A0+A1</b> 35</li>
		<li><b>A2</b> 36</li>
		<li><b>A2+A0</b> 37</li>
		<li><b>A2+A1</b> 38</li>
		<li><b>All</b> 39</li>
	</ul>
	<h3>Interval</h3>
	<p>The interval defines the time between status checks. It is in milliseconds, and the interval starts after the previous check has finished.</p>
	<h3>Message on Change</h3>
	<p>If this option is set, the device will only generate an output message if the status of the inputs or outputs has changed since the last status check or command.</p>
	<h3>Output All Channels</h3>
	<p>By default this device will have 1 output, which will send a payload anytime it detects a status change on the device (or everyime it recieves a message with a topic of "get_status"). Use this option to enable seperate outputs for each channel.</p>
	<h3>Channel Direction</h3>
	<p>Each selected channel will be configured as an output. Any channels left unchecked will be pulled up internally and set as an input.</p>
	<h3>Input values</h3>
	<p>You can send commands to the device through the use of topics and payloads. Any input messages that don't contain a compatible topic will be ignored. The compatible topics are:</p>
	<ul>
		<li><b>get_status</b> Forces a status check outside of the normal interval.</li>
		<li><b>all</b> Allows you to send a single byte to control all channels (see below)</li>
		<li><b>channel_(n)</b> Addresses a specific channel (1-8), and expects a payload of 0 or 1 to turn the output off or on, respectively.</li>
	</ul>
	<i>When sending a single byte to control all channels, the LSB will control channel 1 and the MSB will control channel 8. Set bits turn the output on, unset bits turn the output off.</i>
	<h3>Output Values</h3>
	<p>When Output All Channels is selected, each output represents a channel, the topic will indicate the channel (channel_(n)), and the payload will be 1 or 0</p>
	<p>The last output on the node (the only output if Output All Channels is not selected) will send an object as the payload keyed by the channel, with a 1 or 0 defining the status. A status of 1 on an output indicates that it is active, a status of 1 on an input means it is being pulled to ground.</p>
	<p>i.e.:<br />
	{<br/>
		channel_1:1,<br/>
		channel_2:0,<br/>
		channel_3:0,<br/>
		channel_4:0,<br/>
		channel_5:1,<br/>
		channel_6:1,<br/>
		channel_7:0,<br/>
		channel_8:0<br/>
		}</p>

</script>
